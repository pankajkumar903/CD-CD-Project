trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  azureServiceConnection: azure-connection       # your service connection name
  tfDir: infra                                   # folder containing terraform files

steps:
- checkout: self
  fetchDepth: 0

# Install Terraform
- task: TerraformInstaller@1
  displayName: Install Terraform
  inputs:
    terraformVersion: 1.7.3

# STEP 1: Request OIDC token + expose variables
- task: AzureCLI@2
  displayName: "Request OIDC Token + Export Vars"
  inputs:
    azureSubscription: $(azureServiceConnection)
    scriptType: bash
    scriptLocation: inlineScript
    addSpnToEnvironment: true
    includeAzureSubscription: true
    inlineScript: |
      echo "Exporting Terraform OIDC environment variables..."

      echo "##vso[task.setvariable variable=ARM_CLIENT_ID]$servicePrincipalId"
      echo "##vso[task.setvariable variable=ARM_TENANT_ID]$tenantId"
      echo "##vso[task.setvariable variable=ARM_OIDC_TOKEN]$idToken"

      echo "Service Principal ID: $servicePrincipalId"
      echo "Tenant ID: $tenantId"

# STEP 2: Terraform Init/Plan/Apply with OIDC + Azure CLI login
- task: AzureCLI@2
  displayName: "Terraform Init/Plan/Apply with OIDC"
  inputs:
    azureSubscription: $(azureServiceConnection)
    scriptType: bash
    scriptLocation: inlineScript
    addSpnToEnvironment: true
    includeAzureSubscription: true
    inlineScript: |
      set -euo pipefail

      echo "Azure CLI is logged in through service connection."

      cd $(tfDir)

      # Retrieve subscription dynamically (now Azure CLI is logged in)
      SUBSCRIPTION_ID=$(az account show --query id -o tsv)
      echo "Detected Subscription ID: $SUBSCRIPTION_ID"

      export ARM_USE_OIDC=true
      export ARM_CLIENT_ID=$(ARM_CLIENT_ID)
      export ARM_TENANT_ID=$(ARM_TENANT_ID)
      export ARM_SUBSCRIPTION_ID=$SUBSCRIPTION_ID
      export ARM_OIDC_TOKEN=$(ARM_OIDC_TOKEN)

      echo "---- Terraform Auth Values ----"
      echo "ARM_CLIENT_ID=$ARM_CLIENT_ID"
      echo "ARM_TENANT_ID=$ARM_TENANT_ID"
      echo "ARM_SUBSCRIPTION_ID=$ARM_SUBSCRIPTION_ID"

      echo "------ Terraform Init ------"
      terraform init -input=false

      echo "------ Terraform Plan ------"
      terraform plan -out=tfplan -input=false

      echo "------ Terraform Apply ------"
      terraform apply -auto-approve tfplan

      echo "Terraform completed successfully!"
