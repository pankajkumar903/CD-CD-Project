trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  azureServiceConnection: azure-connection
  tfDir: infra

steps:
- checkout: self
  fetchDepth: 0

- task: TerraformInstaller@1
  displayName: Install Terraform
  inputs:
    terraformVersion: 1.7.3

- task: AzureCLI@2
  displayName: Terraform Init/Plan/Apply using OIDC
  inputs:
    azureSubscription: $(azureServiceConnection)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euo pipefail

      echo "Logged into Azure using Federated Credentials (OIDC)"

      cd $(tfDir)

      # CRITICAL FIX ðŸ‘‰ Tell Terraform to use OIDC NOT Azure CLI
      export ARM_USE_OIDC=true

      echo "------ Terraform Init ------"
      terraform init -input=false

      echo "------ Terraform Plan ------"
      terraform plan -out=tfplan -input=false

      echo "------ Terraform Apply ------"
      terraform apply -auto-approve tfplan

      echo "Terraform completed successfully!"
