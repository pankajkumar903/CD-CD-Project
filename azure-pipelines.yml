trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  azureServiceConnection: azure-connection
  tfDir: infra

steps:
- checkout: self
  fetchDepth: 0

- task: TerraformInstaller@1
  displayName: Install Terraform
  inputs:
    terraformVersion: 1.7.3

- task: AzureCLI@2
  displayName: Terraform Init/Plan/Apply using OIDC
  inputs:
    azureSubscription: $(azureServiceConnection)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euo pipefail

      echo "Logged into Azure using Federated Credentials (OIDC)"

      cd $(tfDir)

      echo "Setting Terraform OIDC environment variables"

      # REQUIRED: tell Terraform to use OIDC
      export ARM_USE_OIDC=true

      # REQUIRED: disable Azure CLI auth (this is causing your error)
      export ARM_USE_AZURECLI=false

      # Optional but recommended for clarity
      export ARM_TENANT_ID="756dd590-85ca-48f4-89cb-f0753277d98c"
      export ARM_SUBSCRIPTION_ID="8618031d-ad43-42d5-b710-12eb173c5621"

      echo "------ Terraform Init ------"
      terraform init -input=false

      echo "------ Terraform Plan ------"
      terraform plan -out=tfplan -input=false

      echo "------ Terraform Apply ------"
      terraform apply -auto-approve tfplan

      echo "Terraform completed successfully!"
