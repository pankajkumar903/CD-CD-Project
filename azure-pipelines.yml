trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  azureServiceConnection: azure-connection
  tfDir: infra

steps:
- checkout: self
  fetchDepth: 0

- task: TerraformInstaller@1
  displayName: Install Terraform
  inputs:
    terraformVersion: 1.7.3

- task: AzureCLI@2
  displayName: Terraform Init/Plan/Apply using OIDC
  inputs:
    azureSubscription: $(azureServiceConnection)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euo pipefail

      echo "Logged into Azure via federated credentials (OIDC)"

      cd $(tfDir)

      echo "Initializing Terraform backend..."
      terraform init -input=false

      echo "Running terraform plan..."
      terraform plan -out=tfplan -input=false

      echo "Running terraform apply..."
      terraform apply -auto-approve tfplan

      echo "Terraform completed successfully"
