trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  azureServiceConnection: azure-connection
  tfDir: infra

steps:
- checkout: self
  fetchDepth: 0

- task: TerraformInstaller@1
  displayName: Install Terraform
  inputs:
    terraformVersion: 1.7.3

# STEP 1: Request OIDC token and export Terraform auth vars
- task: AzureCLI@2
  displayName: "Request OIDC Token"
  inputs:
    azureSubscription: $(azureServiceConnection)
    scriptType: bash
    scriptLocation: inlineScript
    addSpnToEnvironment: true
    inlineScript: |
      echo "Setting Terraform environment variables from Service Connection"
      echo "##vso[task.setvariable variable=ARM_CLIENT_ID]$servicePrincipalId"
      echo "##vso[task.setvariable variable=ARM_TENANT_ID]$tenantId"
      echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$subscriptionId"
      echo "##vso[task.setvariable variable=ARM_OIDC_TOKEN]$idToken"

# STEP 2: Run Terraform using OIDC
- script: |
    set -euo pipefail

    echo "Using OIDC Authentication for Terraform"
    cd $(tfDir)

    export ARM_USE_OIDC=true
    export ARM_CLIENT_ID=$(ARM_CLIENT_ID)
    export ARM_TENANT_ID=$(ARM_TENANT_ID)
    export ARM_SUBSCRIPTION_ID=$(ARM_SUBSCRIPTION_ID)
    export ARM_OIDC_TOKEN=$(ARM_OIDC_TOKEN)

    terraform init -input=false
    terraform plan -out=tfplan -input=false
    terraform apply -auto-approve tfplan

  displayName: "Terraform Init/Plan/Apply with OIDC"
