trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  azureServiceConnection: azure-connection
  tfDir: infra

steps:
- checkout: self
  fetchDepth: 0

# Install Terraform
- task: TerraformInstaller@1
  displayName: Install Terraform
  inputs:
    terraformVersion: 1.7.3

# STEP 1: Request OIDC Token + Export Required Vars
- task: AzureCLI@2
  displayName: "Request OIDC Token + Export Vars"
  inputs:
    azureSubscription: $(azureServiceConnection)
    scriptType: bash
    scriptLocation: inlineScript
    addSpnToEnvironment: true
    includeAzureSubscription: true
    inlineScript: |
      echo "Exporting Terraform OIDC variables..."

      echo "##vso[task.setvariable variable=ARM_CLIENT_ID]$servicePrincipalId"
      echo "##vso[task.setvariable variable=ARM_TENANT_ID]$tenantId"
      echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$subscriptionId"
      echo "##vso[task.setvariable variable=ARM_OIDC_TOKEN]$idToken"

      echo "Service Principal ID: $servicePrincipalId"
      echo "Tenant ID: $tenantId"
      echo "Subscription ID: $subscriptionId"

# STEP 2: Terraform Init / Plan / Apply with OIDC
- script: |
    set -euo pipefail

    echo "Using OIDC Authentication for Terraform"

    cd $(tfDir)

    # REQUIRED ENV VARS FOR BACKEND AUTH + PROVIDER AUTH
    export ARM_USE_OIDC=true
    export ARM_CLIENT_ID=$(ARM_CLIENT_ID)
    export ARM_TENANT_ID=$(ARM_TENANT_ID)
    export ARM_SUBSCRIPTION_ID=$(ARM_SUBSCRIPTION_ID)
    export ARM_OIDC_TOKEN=$(ARM_OIDC_TOKEN)

    echo "ARM_CLIENT_ID=$ARM_CLIENT_ID"
    echo "ARM_TENANT_ID=$ARM_TENANT_ID"
    echo "ARM_SUBSCRIPTION_ID=$ARM_SUBSCRIPTION_ID"

    echo "------ Terraform Init ------"
    terraform init -input=false

    echo "------ Terraform Plan ------"
    terraform plan -out=tfplan -input=false

    echo "------ Terraform Apply ------"
    terraform apply -auto-approve tfplan

  displayName: "Terraform Init/Plan/Apply with OIDC"
